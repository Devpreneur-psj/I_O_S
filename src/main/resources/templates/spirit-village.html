<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정령의 마을 - SOI</title>
    <link rel="stylesheet" th:href="@{/css/spirit-village.css?v=10}">
    <link rel="stylesheet" th:href="@{/css/modal.css}">
    <link rel="stylesheet" th:href="@{/css/shop.css?v=3}">
</head>
<body>
    <div class="spirit-village-container">
        <!-- 배경 -->
        <div class="background-layer">
            <div class="magical-particles"></div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="content-wrapper">
            <div class="village-header">
                <h1 class="title">정령의 마을</h1>
                <p class="subtitle">당신의 정령들을 관리하세요</p>
            </div>

            <!-- 현재 시간 표시 -->
            <div class="game-time-info">
                <div class="current-time-display">
                    <span class="time-label">🕐 현재 시간:</span>
                    <span class="time-value" id="currentTimeDisplay">--:--:--</span>
                </div>
            </div>

            <!-- 활성 이벤트 표시 -->
            <div class="active-events" th:if="${activeEvents != null and !activeEvents.empty}" style="position: absolute; top: 100px; right: 20px; z-index: 150; max-width: 300px;">
                <h3 class="events-title">📢 현재 이벤트</h3>
                <div class="event-list">
                    <div class="event-card" th:each="event : ${activeEvents}" th:classappend="${event.eventType == 'WEATHER'} ? 'event-weather' : (${event.eventType == 'DISEASE'} ? 'event-disease' : (${event.eventType == 'CONFLICT'} ? 'event-conflict' : 'event-special'))">
                        <div class="event-icon" th:switch="${event.eventType}">
                            <span th:case="'WEATHER'">🌤️</span>
                            <span th:case="'DISEASE'">💊</span>
                            <span th:case="'CONFLICT'">⚔️</span>
                            <span th:case="*">⚡</span>
                        </div>
                        <div class="event-info">
                            <div class="event-name" th:text="${event.eventName}">이벤트 이름</div>
                            <div class="event-description" th:text="${event.eventDescription}">이벤트 설명</div>
                            <div class="event-effect" th:if="${event.effect != null and !event.effect.isEmpty()}" th:text="${event.effect}">이벤트 효과</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 정령 목록 (배경 위를 돌아다니는 정령들) -->
            <div class="spirit-walking-area" th:if="${spirits != null and !spirits.empty}">
                <div class="spirit-walker" 
                     th:each="spirit : ${spirits}"
                     th:data-spirit-id="${spirit.id}"
                     th:data-spirit-type="${spirit.spiritType}"
                     th:data-evolution-stage="${spirit.evolutionStage}"
                     th:data-personality="${spirit.personality}"
                     th:data-happiness="${spirit.happiness}"
                     th:data-hunger="${spirit.hunger}"
                     th:data-energy="${spirit.energy}"
                     th:data-health-status="${spirit.healthStatus}"
                     th:data-mood="${spirit.mood}"
                     th:data-evolution-start-time="${spirit.evolutionStartTime != null ? spirit.evolutionStartTime.toString() : ''}"
                     th:onclick="'openSpiritModal(' + ${spirit.id} + ')'"
                     th:classappend="${(spirit.spiritType == '빛의 정령' or spirit.spiritType == '어둠의 정령') and spirit.evolutionStage == 1} ? 'spirit-cocoon' : ''">
                    <!-- 정령 이미지 (기본 단계 불의 정령) -->
                    <img th:src="@{/images/spirits/step1_fire.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '불의 정령' and spirit.evolutionStage == 0}">
                    <!-- 정령 이미지 (1차 진화 불의 정령) -->
                    <img th:src="@{/images/spirits/step2_fire.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '불의 정령' and spirit.evolutionStage == 1}">
                    <!-- 정령 이미지 (2차 진화 불의 정령 - 이그리트) -->
                    <img th:src="@{/images/spirits/step3_fire.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '불의 정령' and spirit.evolutionStage == 2}">
                    <!-- 정령 이미지 (기본 단계 물의 정령) -->
                    <img th:src="@{/images/spirits/step1_water.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '물의 정령' and spirit.evolutionStage == 0}">
                    <!-- 정령 이미지 (1차 진화 물의 정령) -->
                    <img th:src="@{/images/spirits/step2_water.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '물의 정령' and spirit.evolutionStage == 1}">
                    <!-- 정령 이미지 (2차 진화 물의 정령) -->
                    <img th:src="@{/images/spirits/step3_water.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '물의 정령' and spirit.evolutionStage == 2}">
                    <!-- 정령 이미지 (기본 단계 풀의 정령) -->
                    <img th:src="@{/images/spirits/step1_leaf.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '풀의 정령' and spirit.evolutionStage == 0}">
                    <!-- 정령 이미지 (1차 진화 풀의 정령) -->
                    <img th:src="@{/images/spirits/step2_leaf.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '풀의 정령' and spirit.evolutionStage == 1}">
                    <!-- 정령 이미지 (2차 진화 풀의 정령 - 놈) -->
                    <img th:src="@{/images/spirits/step3_leaf.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '풀의 정령' and spirit.evolutionStage == 2}">
                    <!-- 정령 이미지 (기본 단계 빛의 정령) -->
                    <img th:src="@{/images/spirits/step1_light.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '빛의 정령' and spirit.evolutionStage == 0}">
                    <!-- 정령 이미지 (1차 진화 빛의 정령 - 고치 상태) -->
                    <img th:src="@{/images/spirits/step2_light.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image spirit-cocoon-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '빛의 정령' and spirit.evolutionStage == 1}">
                    <!-- 정령 이미지 (2차 진화 빛의 정령 - 디아나) -->
                    <img th:src="@{/images/spirits/step3_light.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '빛의 정령' and spirit.evolutionStage == 2}">
                    <!-- 정령 이미지 (기본 단계 어둠의 정령) -->
                    <img th:src="@{/images/spirits/step1_dark.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '어둠의 정령' and spirit.evolutionStage == 0}">
                    <!-- 정령 이미지 (1차 진화 어둠의 정령 - 고치 상태) -->
                    <img th:src="@{/images/spirits/step2_dark.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image spirit-cocoon-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '어둠의 정령' and spirit.evolutionStage == 1}">
                    <!-- 정령 이미지 (2차 진화 어둠의 정령 - 데스) -->
                    <img th:src="@{/images/spirits/step3_dark.png}" 
                         th:alt="${spirit.name}"
                         class="spirit-walker-image"
                         style="width: 60px !important; height: 60px !important; max-width: 60px !important; max-height: 60px !important;"
                         th:if="${spirit.spiritType == '어둠의 정령' and spirit.evolutionStage == 2}">
                    <!-- 다른 정령 타입은 추후 추가 -->
                    <div class="spirit-walker-name" th:text="${spirit.name}">정령 이름</div>
                    <!-- 말풍선 -->
                    <div class="spirit-speech-bubble" style="display: none;">
                        <div class="speech-bubble-content"></div>
                        <div class="speech-bubble-tail"></div>
                    </div>
                </div>
            </div>

            <div class="empty-message" th:if="${spirits == null or spirits.empty}">
                <p>아직 정령이 없습니다.</p>
                <a href="/spirit/create" class="create-btn">정령 생성하기</a>
            </div>

            <!-- 뒤로가기 버튼 -->
            <div class="back-button">
                <a href="/world" class="back-link">← 월드맵으로</a>
            </div>
        </div>
    </div>

    <!-- 정령 상태 모달 -->
    <div id="spiritModal" class="spirit-modal" style="display: none !important; visibility: hidden; opacity: 0;">
        <div class="spirit-modal-content">
            <span class="spirit-modal-close" onclick="window.closeSpiritModal && window.closeSpiritModal(); return false;">&times;</span>
            
            <!-- 모달 내부는 JavaScript로 동적으로 채워짐 -->
            <div id="spiritModalBody">
                <!-- 정령 정보가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 정령 데이터를 JavaScript로 전달 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const spiritsData = /*[[${spirits}]]*/ [];
        /*]]>*/
    </script>
    
    <script th:src="@{/js/modal.js}"></script>
    <script th:src="@{/js/spirit-village.js?v=41}"></script>
    <script th:src="@{/js/spirit-village-speech.js?v=1}"></script>
</body>
</html>
