<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï†ïÎ†π ÎèÑÏÑúÍ¥Ä - SOI</title>
    <link rel="stylesheet" th:href="@{/css/spirit-codex.css?v=5}">
</head>
<body>
    <div class="codex-container">
        <div class="codex-header">
            <button class="back-btn" onclick="window.location.href='/world'">‚Üê Îí§Î°ú</button>
            <h1>üìñ Ï†ïÎ†π ÎèÑÏÑúÍ¥Ä</h1>
            <p class="subtitle">Î™®Îì† Ï†ïÎ†πÏùò Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§</p>
        </div>

        <!-- ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú -->
        <div th:if="${error != null}" class="error-message" style="background: rgba(255, 0, 0, 0.1); border: 2px solid #ff4444; color: #ff4444; padding: 15px; border-radius: 10px; margin: 20px; text-align: center;">
            <p th:text="${error}">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
        </div>

        <!-- ÌïÑÌÑ∞ -->
        <div class="filter-section">
            <button class="filter-btn active" data-filter="all" onclick="filterSpirits('all')">Ï†ÑÏ≤¥</button>
            <button class="filter-btn" data-filter="common" onclick="filterSpirits('common')">ÏùºÎ∞ò</button>
            <button class="filter-btn" data-filter="rare" onclick="filterSpirits('rare')">Ìù¨Í∑Ä</button>
            <button class="filter-btn" data-filter="owned" onclick="filterSpirits('owned')">ÏÜåÏú†</button>
            <button class="filter-btn" data-filter="not-owned" onclick="filterSpirits('not-owned')">ÎØ∏ÏÜåÏú†</button>
        </div>

        <div class="spirit-types-grid" id="spiritTypesGrid">
            <div th:if="${spiritTypes == null or #lists.isEmpty(spiritTypes)}" class="no-spirits" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                <p>Îì±Î°ùÎêú Ï†ïÎ†π ÌÉÄÏûÖÏù¥ ÏóÜÏäµÎãàÎã§.</p>
            </div>
            
            <!-- Í∞Å Ï†ïÎ†π ÌÉÄÏûÖÎ≥ÑÎ°ú 3Îã®Í≥Ñ Ïπ¥Îìú ÏÉùÏÑ± -->
            <th:block th:each="type : ${spiritTypes}" th:if="${spiritTypes != null and type != null}">
                <!-- 1Îã®Í≥Ñ (Í∏∞Î≥∏) -->
                <th:block th:with="stageKey0=${type.typeName + '_0'},isObtained0=${obtainedStageMap != null and type.typeName != null and obtainedStageMap.containsKey(type.typeName + '_0') and obtainedStageMap.get(type.typeName + '_0')}">
                <div class="spirit-id-card" 
                     th:attr="data-rare=${type.isRare != null ? type.isRare : false},data-type-name=${type.typeName != null ? type.typeName : ''},data-stage='0',data-owned=${isObtained0}"
                     th:classappend="${!isObtained0} ? 'not-obtained' : ''">
                
                <div class="id-card-header">
                    <div class="id-card-title">Ï†ïÎ†π Ï†ïÎ≥¥ Ïπ¥Îìú - 1Îã®Í≥Ñ</div>
                    <span class="rare-badge" th:if="${type.isRare}">Ìù¨Í∑Ä</span>
                </div>
                
                <div class="id-card-body">
                    <div class="id-card-left">
                        <div class="photo-section">
                            <div class="photo-label">ÏÇ¨ÏßÑ</div>
                            <div class="photo-container" th:classappend="${!isObtained0} ? 'unknown-photo' : ''">
                                <div th:if="${isObtained0}">
                                    <img th:if="${type.typeCode == 'FIRE'}" th:src="@{/images/spirits/step1_fire.png}" th:alt="${type.baseStageName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WATER'}" th:src="@{/images/spirits/step1_water.png}" th:alt="${type.baseStageName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WIND'}" th:src="@{/images/spirits/step1_leaf.png}" th:alt="${type.baseStageName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'LIGHT'}" th:src="@{/images/spirits/step1_light.png}" th:alt="${type.baseStageName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'DARK'}" th:src="@{/images/spirits/step1_dark.png}" th:alt="${type.baseStageName}" class="main-photo">
                                </div>
                                <div th:unless="${isObtained0}" class="unknown-spirit">
                                    <div class="unknown-icon">?</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="id-card-right">
                        <div class="info-section">
                            <div class="info-item">
                                <div class="info-label">Ï†ïÎ†π Ï¢ÖÎ•ò</div>
                                <div class="info-value main-name" th:if="${isObtained0}" th:text="${type.typeName}">Ï†ïÎ†π ÌÉÄÏûÖ</div>
                                <div class="info-value main-name unknown-text" th:unless="${isObtained0}">???</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained0}">
                                <div class="info-label">Îã®Í≥Ñ Ïù¥Î¶Ñ</div>
                                <div class="info-value" th:text="${type.baseStageName}">Í∏∞Î≥∏</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained0 and type.weakAgainst != null}">
                                <div class="info-label">ÏïΩÏ†ê</div>
                                <div class="info-value weakness" th:text="${type.weakAgainst}">ÏïΩÏ†ê</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained0 and type.strongAgainst != null}">
                                <div class="info-label">Í∞ïÏ†ê</div>
                                <div class="info-value strength" th:text="${type.strongAgainst}">Í∞ïÏ†ê</div>
                            </div>
                            
                            <div class="info-item ownership-item">
                                <div class="info-label">ÏÜåÏú† ÏÉÅÌÉú</div>
                                <div class="info-value">
                                    <span th:if="${isObtained0}" class="owned">‚úì ÏÜåÏú† Ï§ë</span>
                                    <span th:unless="${isObtained0}" class="not-owned">ÎØ∏Î∞úÍ≤¨</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </th:block>
                
                <!-- 2Îã®Í≥Ñ (1Ï∞® ÏßÑÌôî) -->
                <th:block th:if="${type.firstEvolutionName != null}" th:with="stageKey1=${type.typeName + '_1'},isObtained1=${obtainedStageMap != null and type.typeName != null and obtainedStageMap.containsKey(type.typeName + '_1') and obtainedStageMap.get(type.typeName + '_1')}">
                <div class="spirit-id-card" 
                     th:attr="data-rare=${type.isRare != null ? type.isRare : false},data-type-name=${type.typeName != null ? type.typeName : ''},data-stage='1',data-owned=${isObtained1}"
                     th:classappend="${!isObtained1} ? 'not-obtained' : ''">
                
                <div class="id-card-header">
                    <div class="id-card-title">Ï†ïÎ†π Ï†ïÎ≥¥ Ïπ¥Îìú - 2Îã®Í≥Ñ</div>
                    <span class="rare-badge" th:if="${type.isRare}">Ìù¨Í∑Ä</span>
                </div>
                
                <div class="id-card-body">
                    <div class="id-card-left">
                        <div class="photo-section">
                            <div class="photo-label">ÏÇ¨ÏßÑ</div>
                            <div class="photo-container" th:classappend="${!isObtained1} ? 'unknown-photo' : ''">
                                <div th:if="${isObtained1}">
                                    <img th:if="${type.typeCode == 'FIRE'}" th:src="@{/images/spirits/step2_fire.png}" th:alt="${type.firstEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WATER'}" th:src="@{/images/spirits/step2_water.png}" th:alt="${type.firstEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WIND'}" th:src="@{/images/spirits/step2_leaf.png}" th:alt="${type.firstEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'LIGHT'}" th:src="@{/images/spirits/step2_light.png}" th:alt="${type.firstEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'DARK'}" th:src="@{/images/spirits/step2_dark.png}" th:alt="${type.firstEvolutionName}" class="main-photo">
                                </div>
                                <div th:unless="${isObtained1}" class="unknown-spirit">
                                    <div class="unknown-icon">?</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="id-card-right">
                        <div class="info-section">
                            <div class="info-item">
                                <div class="info-label">Ï†ïÎ†π Ï¢ÖÎ•ò</div>
                                <div class="info-value main-name" th:if="${isObtained1}" th:text="${type.typeName}">Ï†ïÎ†π ÌÉÄÏûÖ</div>
                                <div class="info-value main-name unknown-text" th:unless="${isObtained1}">???</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained1}">
                                <div class="info-label">Îã®Í≥Ñ Ïù¥Î¶Ñ</div>
                                <div class="info-value" th:text="${type.firstEvolutionName}">1Ï∞®</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained1 and type.weakAgainst != null}">
                                <div class="info-label">ÏïΩÏ†ê</div>
                                <div class="info-value weakness" th:text="${type.weakAgainst}">ÏïΩÏ†ê</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained1 and type.strongAgainst != null}">
                                <div class="info-label">Í∞ïÏ†ê</div>
                                <div class="info-value strength" th:text="${type.strongAgainst}">Í∞ïÏ†ê</div>
                            </div>
                            
                            <div class="info-item ownership-item">
                                <div class="info-label">ÏÜåÏú† ÏÉÅÌÉú</div>
                                <div class="info-value">
                                    <span th:if="${isObtained1}" class="owned">‚úì ÏÜåÏú† Ï§ë</span>
                                    <span th:unless="${isObtained1}" class="not-owned">ÎØ∏Î∞úÍ≤¨</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </th:block>
                
                <!-- 3Îã®Í≥Ñ (2Ï∞® ÏßÑÌôî) -->
                <th:block th:if="${type.secondEvolutionName != null}" th:with="stageKey2=${type.typeName + '_2'},isObtained2=${obtainedStageMap != null and type.typeName != null and obtainedStageMap.containsKey(type.typeName + '_2') and obtainedStageMap.get(type.typeName + '_2')}">
                <div class="spirit-id-card" 
                     th:attr="data-rare=${type.isRare != null ? type.isRare : false},data-type-name=${type.typeName != null ? type.typeName : ''},data-stage='2',data-owned=${isObtained2}"
                     th:classappend="${!isObtained2} ? 'not-obtained' : ''">
                
                <div class="id-card-header">
                    <div class="id-card-title">Ï†ïÎ†π Ï†ïÎ≥¥ Ïπ¥Îìú - 3Îã®Í≥Ñ</div>
                    <span class="rare-badge" th:if="${type.isRare}">Ìù¨Í∑Ä</span>
                </div>
                
                <div class="id-card-body">
                    <div class="id-card-left">
                        <div class="photo-section">
                            <div class="photo-label">ÏÇ¨ÏßÑ</div>
                            <div class="photo-container" th:classappend="${!isObtained2} ? 'unknown-photo' : ''">
                                <div th:if="${isObtained2}">
                                    <img th:if="${type.typeCode == 'FIRE'}" th:src="@{/images/spirits/step3_fire.png}" th:alt="${type.secondEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WATER'}" th:src="@{/images/spirits/step3_water.png}" th:alt="${type.secondEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'WIND'}" th:src="@{/images/spirits/step3_leaf.png}" th:alt="${type.secondEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'LIGHT'}" th:src="@{/images/spirits/step3_light.png}" th:alt="${type.secondEvolutionName}" class="main-photo">
                                    <img th:if="${type.typeCode == 'DARK'}" th:src="@{/images/spirits/step3_dark.png}" th:alt="${type.secondEvolutionName}" class="main-photo">
                                </div>
                                <div th:unless="${isObtained2}" class="unknown-spirit">
                                    <div class="unknown-icon">?</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="id-card-right">
                        <div class="info-section">
                            <div class="info-item">
                                <div class="info-label">Ï†ïÎ†π Ï¢ÖÎ•ò</div>
                                <div class="info-value main-name" th:if="${isObtained2}" th:text="${type.typeName}">Ï†ïÎ†π ÌÉÄÏûÖ</div>
                                <div class="info-value main-name unknown-text" th:unless="${isObtained2}">???</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained2}">
                                <div class="info-label">Îã®Í≥Ñ Ïù¥Î¶Ñ</div>
                                <div class="info-value" th:text="${type.secondEvolutionName}">2Ï∞®</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained2 and type.weakAgainst != null}">
                                <div class="info-label">ÏïΩÏ†ê</div>
                                <div class="info-value weakness" th:text="${type.weakAgainst}">ÏïΩÏ†ê</div>
                            </div>
                            
                            <div class="info-item" th:if="${isObtained2 and type.strongAgainst != null}">
                                <div class="info-label">Í∞ïÏ†ê</div>
                                <div class="info-value strength" th:text="${type.strongAgainst}">Í∞ïÏ†ê</div>
                            </div>
                            
                            <div class="info-item ownership-item">
                                <div class="info-label">ÏÜåÏú† ÏÉÅÌÉú</div>
                                <div class="info-value">
                                    <span th:if="${isObtained2}" class="owned">‚úì ÏÜåÏú† Ï§ë</span>
                                    <span th:unless="${isObtained2}" class="not-owned">ÎØ∏Î∞úÍ≤¨</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </th:block>
            </th:block>
        </div>
        
        <!-- ÏùÄÌá¥Ìïú Ï†ïÎ†π Í∏∞Î°ù ÏÑπÏÖò -->
        <div class="retired-spirits-section" th:if="${retiredSpirits != null and !#lists.isEmpty(retiredSpirits)}">
            <h2 class="section-title">üíÄ ÏùÄÌá¥Ìïú Ï†ïÎ†π Í∏∞Î°ù</h2>
            <div class="retired-spirits-grid">
                <div class="retired-id-card" th:each="spirit : ${retiredSpirits}">
                    <div class="id-card-header">
                        <div class="id-card-title">ÏùÄÌá¥ Ï†ïÎ†π Í∏∞Î°ù</div>
                    </div>
                    <div class="id-card-body">
                        <div class="id-card-left">
                            <div class="photo-section">
                                <div class="photo-label">ÏÇ¨ÏßÑ</div>
                                <div class="photo-container">
                                    <img th:src="@{'/images/spirits/step' + (spirit.evolutionStage == 0 ? '1' : spirit.evolutionStage == 1 ? '2' : '3') + '_' + (spirit.spiritType == 'Î∂àÏùò Ï†ïÎ†π' ? 'fire' : spirit.spiritType == 'Î¨ºÏùò Ï†ïÎ†π' ? 'water' : spirit.spiritType == 'ÌíÄÏùò Ï†ïÎ†π' ? 'leaf' : spirit.spiritType == 'ÎπõÏùò Ï†ïÎ†π' ? 'light' : 'dark') + '.png'}" 
                                         th:alt="${spirit.name}"
                                         class="main-photo retired-photo"
                                         onerror="this.src='/images/spirits/step1_fire.png';">
                                </div>
                            </div>
                        </div>
                        <div class="id-card-right">
                            <div class="info-section">
                                <div class="info-item">
                                    <div class="info-label">Ï†ïÎ†π Ïù¥Î¶Ñ</div>
                                    <div class="info-value main-name" th:text="${spirit.name}">Ï†ïÎ†π Ïù¥Î¶Ñ</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Ï†ïÎ†π ÌÉÄÏûÖ</div>
                                    <div class="info-value" th:text="${spirit.spiritType}">Ï†ïÎ†π ÌÉÄÏûÖ</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Î†àÎ≤®</div>
                                    <div class="info-value" th:text="${spirit.level}">1</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÏπúÎ∞ÄÎèÑ</div>
                                    <div class="info-value" th:text="${spirit.intimacy}">1</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÎÇòÏù¥</div>
                                    <div class="info-value" th:text="${spirit.age} + 'Ïùº'">0Ïùº</div>
                                </div>
                                <div class="info-item" th:if="${spirit.retiredAt != null}">
                                    <div class="info-label">ÏùÄÌá¥Ïùº</div>
                                    <div class="info-value" th:text="${#temporals.format(spirit.retiredAt, 'yyyy-MM-dd HH:mm')}">ÎÇ†Ïßú</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Ï†ïÎ†πÏùò Ï∂ïÎ≥µ</div>
                                    <div class="info-value blessing" th:text="${spirit.intimacy * 10} + 'Í∞ú'">10Í∞ú</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Ï†ÑÏó≠ Î≥ÄÏàò Ï†ïÏùò
        var userSpiritTypes = /*[[${userSpiritTypeNamesJson}]]*/ [];
        
        // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Î°úÍ∑∏
        console.log('userSpiritTypes:', userSpiritTypes);
        console.log('userSpiritTypes type:', typeof userSpiritTypes);
        /*]]>*/
        
        // filterSpirits Ìï®Ïàò Ï†ïÏùò (Ï†ÑÏó≠ Ïä§ÏΩîÌîÑ)
        function filterSpirits(filter) {
            var cards = document.querySelectorAll('.spirit-id-card');
            var filterBtns = document.querySelectorAll('.filter-btn');
            
            // ÌïÑÌÑ∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            if (filterBtns && filterBtns.length > 0) {
                for (var i = 0; i < filterBtns.length; i++) {
                    var btn = filterBtns[i];
                    if (btn.getAttribute('data-filter') === filter) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
            
            if (cards && cards.length > 0) {
                for (var j = 0; j < cards.length; j++) {
                    var card = cards[j];
                    var isRare = card.getAttribute('data-rare') === 'true';
                    var typeName = card.getAttribute('data-type-name');
                    var dataOwned = card.getAttribute('data-owned');
                    // data-owned ÏÜçÏÑ±ÏóêÏÑú ÏÜåÏú† Ïó¨Î∂Ä ÌôïÏù∏
                    var isOwned = (dataOwned === 'true');
                    
                    var show = false;
                    
                    switch (filter) {
                        case 'all':
                            show = true;
                            break;
                        case 'common':
                            show = !isRare;
                            break;
                        case 'rare':
                            show = isRare;
                            break;
                        case 'owned':
                            show = isOwned;
                            break;
                        case 'not-owned':
                            show = !isOwned;
                            break;
                        default:
                            show = true;
                    }
                    
                    // Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú Î¶¨ÏÖã
                    card.style.opacity = '';
                    card.style.transform = '';
                    
                    if (show) {
                        card.style.display = 'block';
                        // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÅÏö©
                        setTimeout(function(cardElement) {
                            cardElement.style.opacity = '1';
                            cardElement.style.transform = 'scale(1)';
                        }, 10, card);
                    } else {
                        // Ï¶âÏãú Ïà®ÍπÄ (Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥)
                        card.style.display = 'none';
                        card.style.opacity = '';
                        card.style.transform = '';
                    }
                }
            }
        }
        
        // DOM Î°úÎìú ÏôÑÎ£å ÌõÑ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Spirit Codex page loaded');
            // Ï¥àÍ∏∞ ÌïÑÌÑ∞: Ï†ÑÏ≤¥
            try {
                if (typeof filterSpirits === 'function') {
                    filterSpirits('all');
                } else {
                    console.error('filterSpirits function not found');
                }
            } catch (error) {
                console.error('Error initializing filter:', error);
            }
        });
        /*]]>*/
    </script>
</body>
</html>
